<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">   
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content=""> 
    <title>L-App</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/tiny-slider.css">
    <link rel="stylesheet" href="/assets/css/vendors/bootstrap.css">
    <link rel="stylesheet" href="/assets/css/vendors/material-icon-round.css">
    <link rel="stylesheet" href="/assets/css/vendors/normalize.css">
    <link rel="stylesheet" href="/assets/css/vendors/perfect-scrollbar.css">
    <link rel="stylesheet" href="/assets/css/vendors/select2.min.css">
    <!-- bootstrap link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">        
    <!-- fontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/lightgallery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<style>
    body {
        background: radial-gradient(circle, rgb(136, 203, 192), #3c5d50);
    }
    .cancel-button {
            padding: 8px 16px;
            border: 1px solid #dc3545;
            border-radius: 20px;
            color: #dc3545;
            background-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .cancel-button:hover {
            background-color: #dc3545;
            /* Red background on hover */
            color: #fff;
            /* White text color on hover */
        }
        /* .badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background-color: red;
    color: white;
    border-radius: 50%;
    padding: 3px 6px;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
} */
</style>
<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top" style="background-color: #3c5d50;">
      <a href="/" class="brand-wrap text-light text-decoration-none">
        <h2 style="font-size: 20px; font-weight: bold"><span class="text-warning">L</span>App</h2>
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
            <a class="menu-link" href="/userAccount"> <i class="icon material-icons md-person"></i>
                <span class="text">Info</span>
            </a>
        </li>
        <li class="menu-item active">
            <a class="menu-link" href="/orders"> <i class="icon material-icons md-shopping_cart"></i>
                <span class="text">Orders</span>
            </a>
        </li>
       
        <li class="menu-item ">
            <a class="menu-link" href="/wallet"> <i class="icon material-icons md-account_balance_wallet"></i>
                <span class="text">Wallet</span>
            </a>
        </li>
        <li class="menu-item">
            <a class="menu-link" href="/changePassword"> <i class="icon material-icons md-vpn_key"></i>
                <span class="text">Change password</span>
            </a>
        </li>
        <li class="menu-item ">
            <a class="nav-link d-flex text-danger ms-2" href="/userLogout">
                <span class="material-symbols-outlined">
                    logout
                </span>
            </a>
        </li>
      </ul>
    </nav>
  </aside>
<section class="printable-section">
    <div class="container py-5">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-10 col-xl-8">
                <div class="card" style="border-radius: 10px;">
                    <div class="card-header px-4 py-5">
                        <h5 class="text-muted mb-0">Thanks for your Order, <span style="color: #a8729a;">
                                <%=order.userId.username%>
                            </span>!</h5>
                        <hr style="width: 300px;">
                        <h6><strong>Delivery Address</strong></h6>
                        <div class="col-lg-6">
                            <div class="mb-3 mb-lg-0">
                                <div>
                                    <!-- Address details -->
                                    <address>
                                        <%= order.addresstoDeliver.houseName %>,<br>
                                            <%= order.addresstoDeliver.place %>,<br>
                                                <%= order.addresstoDeliver.district %>,<br>
                                                    <%= order.addresstoDeliver.pinCode %>,<br>India<br>
                                    </address>
                                </div>
                            </div>
                        </div>
                        <p class="fw-bold mb-0">Order Details:</p>
                        <hr>
                        <div>
                            <p class="m-0">OrderId : <b>#<%= order._id %></b></p>
                            <p class="m-0">Payment method : <%= order.paymentMethod %></p>
                            <p class="m-0">Date : <%= order.date.toLocaleDateString() %></p>
                            <p class="m-0 ">Payment Status:
                            <% if(order.paymentStatus == 'paid'){ %>
                                <img src="/static/images/paidPNG.png" width="100" alt="img">
                                <% }else{%> Pending <% } %></p>
                        </div>
                        <hr>
                        <p class="fw-bold mb-0">Product Details:</p>
                        <div class="card-body p-4" style="background-color: #f8f8f8;">
                            <% if (order.products && order.products.length> 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Image</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Qty</th>
                                                    <th scope="col">Total</th>
                                                    <th scope="col">Order Status</th>
                                                    <th scope="col">Payment Status</th>
                                                    <th scope="col">Action</th>
                                                    
                                                </tr>
                                            </thead>
                                                <tbody>
                                                         <% order.products.reverse().forEach((item,index)=> { %> 
                                                    <tr>
                                                        <td><img src="/<%= item.product.image[0] %>" alt="" width="50px"></td>
                                                        <td><b><%= item.product.productTitle %></b></td>
                                                        <td><%= item.quantity %></td>
                                                        <td>₹<%= item.price * item.quantity%></td>
                                                        <% if (item.orderStatus == false && order.orderStatus !== 'Cancelled') { %>
                                                            <td><span class="badge rounded-pill alert-success text-black"><%= order.orderStatus %></span></td>
                                                            <% } else if(item.orderStatus == true) { %>
                                                                <td><span class="badge rounded-pill alert-warning text-black">Cancelled</span></td>
                                                        <% } %>   
                                                        <td><% if(order.paymentStatus == 'paid'){ %>
                                                            <span class="badge rounded-pill alert-success text-black">Paid</span>
                                                            <% }else{ %>
                                                                <span class="badge rounded-pill alert-warning text-black">Pending</span>
                                                                <% } %>
                                                        </td>  
                                                        <% if(order.orderStatus !== 'Delivered' && item.orderStatus !== true && order.orderStatus!=='Returned'){ %>
                                                            <input type="hidden" value="<%= item.product._id %>" id="item-productId<%= index %>">
                                                            <input type="hidden" value="<%= order._id %>" id="orderId<%= index %>">
                                                        <td><a class="btn btn-danger" onclick="singleProductCancelButton('<%= index %>')">Cancel</a></td>
                                                        <% } %> 
                                                    </tr>
                                                    <% }) %>
                                                    <% } else { %>
                                                        <h3 class="text-secondery text-center">can't find Product</h3>
                                                      <% } %>
                                                </tbody>
                                        </table>
                                    </div>
                                            <!-- Display order details -->
                                            <div class="text-end">
                                                <p class="text-muted mb-0"><span class="fw-bold me-4">Delivery
                                                        Charges : </span>  free</p>
                                            </div>
                                            <div class='text-end'>
                                                <p class="text-muted mb-0"><span class="fw-bold me-4">Grand Total :</span>₹
                                                    <b><%= order.totalAmount %></b>
                                                </p>
                                            </div>
                        </div>
                        <div class="card-footer border-0 px-4 py-5"
                            style="background-color:rgb(136, 203, 192) ; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
                            <h5
                                class="d-flex align-items-center justify-content-end text-white text-uppercase mb-0">
                                Total Bill: <span class="h2 mb-0 ms-2"></span>₹ <%= order.totalAmount %>
                            </h5>
                        </div>
                        <% if (order.paymentStatus == 'paid' || order.paymentStatus == 'refunded') { %>
                            <div class="text-center mt-3">
                                <a href="/downloadInvoice/<%= order._id %>" class=" btn btn-primary ">Download invoice</a>
                            </div>
                         <% } %>
                    </div>
                </div>
            </div>
        </div>
</section>
<script>
    function cancelOrder(productId,orderId) {
       
                fetch('/cancelOrder', {
                    method: "PATCH",
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Something went wrong!');
                        }
                        return response.json();
                    })
                    .then(data => {
                        setTimeout(() => {
                            location.reload()
                        }, 2000);
                    })
            }
        
    function singleProductCancelButton(i){
        const productId = document.getElementById(`item-productId${i}`).value
        const orderId = document.getElementById(`orderId${i}`).value
        fetch(`/singleOrderCancel?orderId=${orderId}&productId=${productId}`,{
            method:'GET',
        })
        .then(data=>{
            window.location.reload()
        })
    }
</script>

